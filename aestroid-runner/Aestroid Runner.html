<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asteroid Runner</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            background-color: #000;
            color: #fff;
        }
        #game-canvas {
            display: block;
        }
        .ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .hidden {
            display: none;
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
        }
        button {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5rem;
            padding: 10px 20px;
            background-color: transparent;
            border: 2px solid #fff;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            background-color: #fff;
            color: #000;
            box-shadow: 0 0 15px #fff;
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 20px);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }
        #hud-left {
            display: flex;
            gap: 20px;
        }
        #hud-score, #hud-speed, #hud-multiplier {
            font-size: 1.5rem;
            text-shadow: 0 0 5px #0ff;
        }
        #hud-multiplier {
            position: absolute;
            top: 0;
            left: 200px; /* Adjust as needed */
        }
        #hud-speed {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        #game-over-menu p {
            font-size: 1.2rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <canvas id="game-canvas"></canvas>

    <div id="main-menu" class="ui-container">
        <h1>ASTEROID RUNNER</h1>
        <button id="start-button">Start Game</button>
    </div>

    <div id="hud" class="hidden">
        <div id="hud-left">
            <div id="hud-score">Score: 0</div>
            <div id="hud-multiplier">x1.0</div>
        </div>
        <div id="hud-speed">Speed: 0</div>
    </div>

    <div id="pause-menu" class="ui-container hidden">
        <h1>Paused</h1>
        <button id="resume-button">Resume</button>
    </div>

    <div id="game-over-menu" class="ui-container hidden">
        <h1>Game Over</h1>
        <h2 id="final-score"></h2>
        <button id="menu-button">Return to Main Menu</button>
        <p>Press Spacebar to Restart</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.127.0/build/three.module.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('game-canvas');
        const mainMenu = document.getElementById('main-menu');
        const hud = document.getElementById('hud');
        const scoreEl = document.getElementById('hud-score');
        const speedEl = document.getElementById('hud-speed');
        const multiplierEl = document.getElementById('hud-multiplier');
        const pauseMenu = document.getElementById('pause-menu');
        const gameOverMenu = document.getElementById('game-over-menu');
        const finalScoreEl = document.getElementById('final-score');
        const startButton = document.getElementById('start-button');
        const resumeButton = document.getElementById('resume-button');
        const menuButton = document.getElementById('menu-button');

        // --- GAME STATE & CONSTANTS ---
        let scene, camera, renderer, spaceship, starfield;
        let asteroids = [];
        let pickups = [];
        let gameState = 'MENU';
        let score = 0;
        let scoreMultiplier = 1.0;
        let potentialSpeed = 0; // The speed that auto-accelerates
        let actualSpeed = 0;    // The speed the ship is actually moving at
        const keys = {};

        const BASE_SPEED = 0.1;
        const MAX_SPEED = 2.0;
        const ACCELERATION = 0.0005;
        const STEER_SPEED = 0.45;
        const BRAKE_SPEED = 0.3;
        const ASTEROID_SPAWN_INTERVAL = 250; // ms
        const PICKUP_SPAWN_INTERVAL = 5000; // ms
        let lastAsteroidSpawnTime = 0;
        let lastPickupSpawnTime = 0;

        // --- THREE.JS SETUP ---
        function init() {
            // Scene
            scene = new THREE.Scene();

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 15);
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Lights
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            // Game Objects
            spaceship = createSpaceship();
            scene.add(spaceship);

            starfield = createStarfield();
            scene.add(starfield);

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);
            startButton.addEventListener('click', startGame);
            resumeButton.addEventListener('click', resumeGame);
            menuButton.addEventListener('click', () => window.location.reload());

            animate();
        }

        // --- GAME OBJECT CREATION ---
        function createSpaceship() {
            const group = new THREE.Group();
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8, roughness: 0.4 });
            const cockpitMaterial = new THREE.MeshStandardMaterial({ color: 0x00aaff, emissive: 0x00aaff, emissiveIntensity: 0.5 });

            const body = new THREE.Mesh(new THREE.ConeGeometry(1, 3, 8), bodyMaterial);
            body.rotation.x = Math.PI / 2;
            group.add(body);

            const cockpit = new THREE.Mesh(new THREE.SphereGeometry(0.5, 16, 16), cockpitMaterial);
            cockpit.position.z = 0.5;
            group.add(cockpit);
            
            group.userData.collider = new THREE.Box3(new THREE.Vector3(), new THREE.Vector3());
            group.userData.collider.setFromObject(group);

            return group;
        }

        function createStarfield() {
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = THREE.MathUtils.randFloatSpread(2000);
                const y = THREE.MathUtils.randFloatSpread(2000);
                const z = THREE.MathUtils.randFloatSpread(2000);
                starVertices.push(x, y, z);
            }
            const starGeometry = new THREE.BufferGeometry();
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });
            return new THREE.Points(starGeometry, starMaterial);
        }

        function createAsteroid() {
            const size = THREE.MathUtils.randFloat(1, 5);
            const geometry = new THREE.IcosahedronGeometry(size, 0);
            const material = new THREE.MeshStandardMaterial({ color: 0x888888, flatShading: true, roughness: 1 });
            const asteroid = new THREE.Mesh(geometry, material);

            asteroid.position.x = THREE.MathUtils.randFloatSpread(50);
            asteroid.position.y = THREE.MathUtils.randFloatSpread(50);
            asteroid.position.z = camera.position.z - 300;

            asteroid.userData.rotationSpeed = new THREE.Vector3(
                THREE.MathUtils.randFloat(-0.01, 0.01),
                THREE.MathUtils.randFloat(-0.01, 0.01),
                THREE.MathUtils.randFloat(-0.01, 0.01)
            );
            
            asteroid.userData.collider = new THREE.Box3(new THREE.Vector3(), new THREE.Vector3());
            asteroid.userData.collider.setFromObject(asteroid);

            asteroids.push(asteroid);
            scene.add(asteroid);
        }

        function createPickup() {
            const geometry = new THREE.TorusGeometry(0.8, 0.3, 16, 100);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0xffff00, 
                emissive: 0xffff00, 
                emissiveIntensity: 0.8,
                metalness: 0.5,
                roughness: 0.2
            });
            const pickup = new THREE.Mesh(geometry, material);

            pickup.position.x = THREE.MathUtils.randFloatSpread(50);
            pickup.position.y = THREE.MathUtils.randFloatSpread(50);
            pickup.position.z = camera.position.z - 300;

            pickup.userData.collider = new THREE.Box3(new THREE.Vector3(), new THREE.Vector3());
            pickup.userData.collider.setFromObject(pickup);

            pickups.push(pickup);
            scene.add(pickup);
        }

        // --- GAME STATE MANAGEMENT ---
        function startGame() {
            resetGame();
            gameState = 'PLAYING';
            mainMenu.classList.add('hidden');
            hud.classList.remove('hidden');
        }

        function pauseGame() {
            if (gameState !== 'PLAYING') return;
            gameState = 'PAUSED';
            pauseMenu.classList.remove('hidden');
        }

        function resumeGame() {
            if (gameState !== 'PAUSED') return;
            gameState = 'PLAYING';
            pauseMenu.classList.add('hidden');
        }

        function triggerGameOver() {
            gameState = 'GAME_OVER';
            hud.classList.add('hidden');
            finalScoreEl.textContent = `Final Score: ${Math.floor(score)}`;
            gameOverMenu.classList.remove('hidden');
        }
        
        function restartGame() {
            gameOverMenu.classList.add('hidden');
            startGame();
        }

        function resetGame() {
            score = 0;
            scoreMultiplier = 1.0;
            potentialSpeed = BASE_SPEED;
            actualSpeed = BASE_SPEED;
            spaceship.position.set(0, 0, 0);
            spaceship.rotation.set(0, 0, 0);
            camera.position.set(0, 5, 15);
            
            asteroids.forEach(a => scene.remove(a));
            asteroids = [];
            pickups.forEach(p => scene.remove(p));
            pickups = [];
        }

        // --- EVENT HANDLERS ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onKeyDown(e) {
            keys[e.code] = true;
            if (e.code === 'KeyP' || e.code === 'Escape') {
                if (gameState === 'PLAYING') pauseGame();
                else if (gameState === 'PAUSED') resumeGame();
            }
            if (e.code === 'Space' && gameState === 'GAME_OVER') {
                restartGame();
            }
        }

        function onKeyUp(e) {
            keys[e.code] = false;
        }

        // --- GAME LOOP ---
        function update() {
            // --- Speed Management ---
            const targetSpeed = keys['Space'] && gameState === 'PLAYING' ? BRAKE_SPEED : potentialSpeed;
            actualSpeed = THREE.MathUtils.lerp(actualSpeed, targetSpeed, 0.1); // Smoothly interpolate to the target speed

            // Auto-acceleration of potential speed
            if (potentialSpeed < MAX_SPEED) {
                potentialSpeed += ACCELERATION;
            }

            // --- Player Movement ---
            if (keys['ArrowUp']) spaceship.position.y += STEER_SPEED;
            if (keys['ArrowDown']) spaceship.position.y -= STEER_SPEED;
            if (keys['ArrowLeft']) spaceship.position.x -= STEER_SPEED;
            if (keys['ArrowRight']) spaceship.position.x += STEER_SPEED;

            const bounds = { x: 25, y: 15 };
            spaceship.position.x = THREE.MathUtils.clamp(spaceship.position.x, -bounds.x, bounds.x);
            spaceship.position.y = THREE.MathUtils.clamp(spaceship.position.y, -bounds.y, bounds.y);

            spaceship.position.z -= actualSpeed;

            // --- Camera and Environment ---
            camera.position.x = spaceship.position.x;
            camera.position.y = spaceship.position.y + 5;
            camera.position.z = spaceship.position.z + 15;
            camera.lookAt(spaceship.position);
            starfield.position.z = spaceship.position.z;

            // --- Spawning ---
            const now = performance.now();
            if (now - lastAsteroidSpawnTime > ASTEROID_SPAWN_INTERVAL) {
                createAsteroid();
                lastAsteroidSpawnTime = now;
            }
            if (now - lastPickupSpawnTime > PICKUP_SPAWN_INTERVAL) {
                createPickup();
                lastPickupSpawnTime = now;
            }

            // --- Object Updates & Asteroid Collision ---
            spaceship.userData.collider.setFromObject(spaceship).expandByScalar(-0.3);
            for (let i = asteroids.length - 1; i >= 0; i--) {
                const asteroid = asteroids[i];
                asteroid.rotation.x += asteroid.userData.rotationSpeed.x;
                asteroid.rotation.y += asteroid.userData.rotationSpeed.y;

                if (asteroid.position.z > camera.position.z) {
                    scene.remove(asteroid);
                    asteroids.splice(i, 1);
                    continue;
                }

                asteroid.userData.collider.setFromObject(asteroid).expandByScalar(-0.5);
                if (spaceship.userData.collider.intersectsBox(asteroid.userData.collider)) {
                    triggerGameOver();
                    return; // Exit update loop on game over
                }
            }

            // --- Pickup Collision ---
            for (let i = pickups.length - 1; i >= 0; i--) {
                const pickup = pickups[i];
                pickup.rotation.y += 0.02;

                if (pickup.position.z > camera.position.z) {
                    scene.remove(pickup);
                    pickups.splice(i, 1);
                    continue;
                }

                pickup.userData.collider.setFromObject(pickup);
                if (spaceship.userData.collider.intersectsBox(pickup.userData.collider)) {
                    scoreMultiplier += 0.5;
                    scene.remove(pickup);
                    pickups.splice(i, 1);
                }
            }

            // --- Score & HUD Update ---
            score += actualSpeed * 0.1 * scoreMultiplier;
            scoreEl.textContent = `Score: ${Math.floor(score)}`;
            multiplierEl.textContent = `x${scoreMultiplier.toFixed(1)}`;
            speedEl.textContent = `Speed: ${(actualSpeed * 100).toFixed(0)}`;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (gameState === 'PLAYING') {
                update();
            }

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
